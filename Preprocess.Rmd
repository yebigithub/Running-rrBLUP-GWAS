---
title: "Match hyper, geno, pheno"
author: "yebi"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "~/Library/CloudStorage/OneDrive-VirginiaTech/Research/Codes/research/RiceUNLHyperspec/Geno/codes")
path = "/Users/yebi/Library/CloudStorage/OneDrive-VirginiaTech/Research/Codes/research/RiceUNLHyperspec/GWAS"

```

## loading pacakges.

```{r}
library(lme4)
library(tidyverse)
library(readxl)
```

## Read in pheno data --- Hyperspectral data.

```{r, eval = F}
hyp_control <- read_excel("../../Hyperspec/Big_HNT2018_Hyperspec_Data_TG_PP_v6.xlsx", sheet = 1)
hyp_stress <- read_excel("../../Hyperspec/Big_HNT2018_Hyperspec_Data_TG_PP_v6.xlsx", sheet = 2)

hyp_control$NSFTV_Id <- paste0("NSFTV_", hyp_control$NSFTV_Id)
hyp_stress$NSFTV_Id <- paste0("NSFTV_", hyp_stress$NSFTV_Id)

colnames(hyp_control)[-c(1:2)] <- paste0("hyp_", colnames(hyp_control)[-c(1:2)])
colnames(hyp_stress)[-c(1:2)] <- paste0("hyp_", colnames(hyp_stress)[-c(1:2)])

dup.ix = duplicated(hyp_control$NSFTV_Id)
hyp_control = hyp_control[!dup.ix, ] #remove one duplicated NSFTV.Id

table(hyp_control$NSFTV_Id %in% hyp_stress$NSFTV_Id)
table(hyp_stress$NSFTV_Id %in% hyp_control$NSFTV_Id)
```

## Read in geno and map data.

```{r, eval = F}
geno_700k <- readRDS("../geno_final_700K.rds")
map_700k <- readRDS("../mapinfo_final_700k.rds")
map_700k = map_700k[,c(2,1,4)]
colnames(map_700k) = c("SNPName","Chromosome","Position")
colnames(geno_700k) = map_700k$SNPName
```

### Control --- hpy v.s. geno

```{r, eval = F}
hyp_control = hyp_control[hyp_control$NSFTV_Id %in% rownames(geno_700k), ] # 223*242
geno_control = geno_700k[rownames(geno_700k) %in% hyp_control$NSFTV_Id, ] # 223*411066
geno_control = geno_control[match(hyp_control$NSFTV_Id, rownames(geno_control)), ]

p_control <- colMeans(geno_control)/2
maf_control <- ifelse(p_control > 0.5, 1-p_control, p_control)
maf_control.index <- which(maf_control < 0.05) 
geno_control <- geno_control[,-maf_control.index] #223 391936
map_control <- map_700k[-maf_control.index, ] #391936      3

table(rownames(geno_control) == hyp_control$NSFTV_Id)
table(colnames(geno_control) == map_control$SNPName)
```

### Stress -- hyp v.s. geno

```{r, eval = F}
hyp_stress = hyp_stress[hyp_stress$NSFTV_Id %in% rownames(geno_700k), ] # 223*242
geno_stress = geno_700k[rownames(geno_700k) %in% hyp_stress$NSFTV_Id, ] # 215*411066
geno_stress = geno_stress[match(hyp_stress$NSFTV_Id, rownames(geno_stress)), ]

p_stress <- colMeans(geno_stress)/2
maf_stress <- ifelse(p_stress > 0.5, 1-p_stress, p_stress)
maf_stress.index <- which(maf_stress < 0.05) 
geno_stress <- geno_stress[,-maf_stress.index] #215 390232
map_stress <- map_700k[-maf_stress.index, ] #390232      3

table(rownames(geno_stress) == hyp_stress$NSFTV_Id)
table(colnames(geno_stress) == map_stress$SNPName)
```

```{r}
save(geno_control, geno_stress, file=file.path(path,"geno.rr.RData"))
save(hyp_control, hyp_stress, file = file.path(path, "hyp.rr.Rdata"))
save(map_control, map_stress, file = file.path(path, "map.rr.Rdata"))
```
